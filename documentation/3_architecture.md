# MIDI Keyboard Architecture

## High Level Description

The system will operate as a hierarchical state machine with two orthogonal states. 

The Menus superstate will comprise of specific xMenu substates. In this project, there will be two substates: DrumpadMenu and InstrumentMenu. Two buttons will navigate through menus by generating MENU_NEXT and MENU_PREV events. Additionally, the Menus state will periodically call the lv_task_handler() to handle any callbacks triggered by touchscreen buttons.

The MIDIHandler state will respond to MIDI events generated by button press callbacks and interrupts. Communication with the UART4 peripheral will be isolated to this state.

The current implementation of lv_task_handler() constantly queries the I2C1 bus. Therefore, the I2C2 bus will be broken out to accommodate the I/O expanders.

A set of console commands will send events to each orthogonal state for debugging and development purposes.
 

## Hardware Modules

- PCF8575 I/O Expander
- LCD Touchscreen
- VS1053 Shield
- Discovery Board (STM32L4)

## Software Modules
- MIDI
- PCF8575 input with interrupts
- Touchscreen input with interrupts
- Graphical user interface
- Logging

## Communication 
- UART4 (MIDI)
- UART1 (Logging)
- I2C1 (Touchscreen)
- I2C2 (I/O Expanders)
- GPIO (Interrupts)
- SPI (LCD Display)

